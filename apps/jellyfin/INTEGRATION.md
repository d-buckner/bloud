# Jellyfin + Authentik LDAP Auto-Configuration

## Status: In Progress

This integration automatically configures Jellyfin with LDAP authentication via Authentik's LDAP outpost.

## Architecture Decisions

### Why a Separate LDAP Outpost Container?

Authentik's [embedded outpost](https://version-2024-8.goauthentik.io/docs/outposts/embedded/) only supports HTTP/Proxy protocols. LDAP requires a separate container because:

1. **Protocol Mismatch**: LDAP is not an HTTP protocol, so it can't run inside Django
2. **Language Choice**: The [LDAP outpost is written in Go](https://goauthentik.io/blog/2024-04-04-why-we-built-authentik-outposts-as-microservices/) to leverage existing LDAP libraries
3. **Port Binding**: LDAP needs its own ports (389/636) separate from HTTP

### Token Retrieval Strategy

Authentik auto-generates outpost tokens with random values when an outpost is created. Our approach:

1. **Blueprint creates LDAP Provider + Outpost** (identified by name, not hardcoded UUID)
2. **LDAP container queries token at startup** - the container's prestart script:
   - Uses the Authentik bootstrap token to query the API
   - Queries `/api/v3/outposts/instances/?name=Bloud%20LDAP%20Outpost` to get the outpost UUID
   - Queries `/api/v3/core/tokens/?identifier=ak-outpost-{uuid}-api` to get the auto-generated token
   - Writes token to an env file
   - Container starts with `--env-file` to read the token

This approach is clean because:
- Single point of responsibility (LDAP service handles its own auth)
- Uses existing bootstrap token (no temporary token creation needed)
- No race conditions - token query happens synchronously before container starts
- Env file approach works with systemd and podman natively

## How It Works

### 1. When Jellyfin is installed:
- The LDAP plugin (v22.0.0.0) is automatically installed via a systemd oneshot service
- Authentik's LDAP outpost is enabled (`bloud.apps.authentik.ldap.enable = true`)
- The LDAP blueprint is generated creating:
  - LDAP Provider in Authentik
  - `ldap-service` service account for bind operations
  - `jellyfin-users` and `jellyfin-admins` groups
  - LDAP Outpost (token auto-generated by Authentik)

### 2. LDAP Container Startup:
1. Wait for Authentik server to be healthy (via `waitFor` healthcheck)
2. Run prestart script which:
   - Uses bootstrap token to query Authentik API
   - Finds "Bloud LDAP Outpost" by name
   - Gets the auto-generated token key (`ak-outpost-{uuid}-api`)
   - Writes `AUTHENTIK_TOKEN=<key>` to env file
3. Container starts with `--env-file` containing the token

### 3. Jellyfin Configurator Flow:
1. **PreStart**: Creates config directories
2. **HealthCheck**: Waits for `/health` endpoint
3. **PostStart**:
   - Checks if startup wizard is complete
   - If not: Completes wizard via API with bootstrap admin
   - Configures LDAP plugin via `/Plugins/{id}/Configuration` API
   - Deletes bootstrap admin after LDAP is verified

### 4. LDAP Configuration:
```
LDAP Server: localhost
LDAP Port: 3389
Base DN: dc=ldap,dc=goauthentik,dc=io
Bind DN: cn=ldap-service,ou=users,dc=ldap,dc=goauthentik,dc=io
Search Filter: (objectClass=user)
Admin Filter: (memberOf=cn=jellyfin-admins,ou=groups,dc=ldap,dc=goauthentik,dc=io)
```

## Files Modified

| File | Purpose |
|------|---------|
| `apps/jellyfin/configurator.go` | Wizard completion + LDAP configuration |
| `apps/jellyfin/module.nix` | LDAP plugin install + enable LDAP outpost |
| `apps/jellyfin/metadata.yaml` | SSO strategy: ldap |
| `apps/authentik/module.nix` | LDAP outpost container with token query |
| `services/host-agent/internal/sso/blueprint.go` | LDAP blueprint templates |

## Key API Calls

### Authentik API (for LDAP token retrieval at container startup)
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v3/outposts/instances/?name=Bloud%20LDAP%20Outpost` | GET | Get LDAP outpost UUID |
| `/api/v3/core/tokens/?identifier=ak-outpost-{uuid}-api` | GET | Get auto-generated token key |

### Jellyfin API
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/health` | GET | Health check |
| `/System/Info/Public` | GET | Check wizard status |
| `/Startup/Configuration` | POST | Set initial config |
| `/Startup/User` | POST | Create bootstrap admin |
| `/Startup/RemoteAccess` | POST | Configure remote access |
| `/Startup/Complete` | POST | Finalize wizard |
| `/Plugins/{id}/Configuration` | GET/POST | LDAP plugin config |
| `/Users/AuthenticateByName` | POST | Get access token |
| `/Users` | GET | List users |
| `/Users/{id}` | DELETE | Remove bootstrap admin |

## Manual Setup Required

### Media Libraries
After installation, you must manually configure media libraries in Jellyfin:

1. Log in with the bootstrap admin (`bloud-bootstrap-admin` / `bloud-bootstrap-password-change-me`)
2. Go to **Dashboard** > **Libraries**
3. Add libraries for the mounted media directories:
   - **Movies**: `/movies` (maps to host's shared media directory)
   - **TV Shows**: `/tv` (maps to host's shared media directory)

These directories are mounted read-only from the host's shared media storage.

### LDAP User Groups
Before users can log in via LDAP, they must be added to the appropriate Authentik groups:
- `jellyfin-users` - Required for basic access
- `jellyfin-admins` - Grants admin privileges in Jellyfin

## Testing

```bash
# Start dev environment
./bloud start

# Install Jellyfin (LDAP outpost auto-starts)
# via UI or API

# Check logs
./bloud shell "journalctl --user -u podman-jellyfin -f"

# Verify LDAP outpost is running
./bloud shell "systemctl --user status podman-apps-authentik-ldap"

# Check LDAP outpost logs for token errors
./bloud shell "podman logs apps-authentik-ldap"

# Test login with Authentik user
# (add user to jellyfin-users group in Authentik first)
```

## TODO

- [x] Get real SHA256 hash for LDAP plugin fetchurl
- [x] Blueprint creates LDAP outpost by name (not hardcoded UUID)
- [x] Research embedded outpost - confirmed LDAP requires separate container
- [x] Implement token query at LDAP container startup (prestart script with API query)
- [ ] Test with actual Authentik LDAP outpost
- [ ] Verify group membership filtering works
- [ ] Auto-configure media libraries via API

## References

- [Authentik Outposts Documentation](https://docs.goauthentik.io/add-secure-apps/outposts/)
- [Authentik LDAP Provider](https://docs.goauthentik.io/add-secure-apps/providers/ldap)
- [Why Authentik Built Outposts as Microservices](https://goauthentik.io/blog/2024-04-04-why-we-built-authentik-outposts-as-microservices/)
