# Traefik - Bloud Integration

## Port & Network
- **Port:** 8080
- **Network:** `host` (accesses all services on localhost)

## Configuration Storage
```
~/.local/share/bloud/traefik/
├── traefik.yml           # Main config
└── dynamic/
    ├── base.yml          # Static routes (NixOS)
    └── apps-routes.yml   # Generated by traefikgen
```

## Priority Levels

| Priority | Route Type |
|----------|------------|
| 100 | Embed routes (`/embed/*`) |
| 99 | Actual-budget static assets |
| 98 | Actual-budget API |
| 95 | Dashboard |
| 90 | Host agent API |
| 1 | Bloud UI (catch-all) |

## Middlewares

### iframe-headers
Removes restrictive headers for embedding:
```yaml
X-Frame-Options: ""
Content-Security-Policy: ""
```

### embed-isolation
Adds COOP/COEP for same-origin iframe access:
```yaml
Cross-Origin-Opener-Policy: "same-origin"
Cross-Origin-Embedder-Policy: "credentialless"
```

**Skipped** for apps with custom COEP in `metadata.yaml`.

### cross-origin-isolation
Applied to parent Bloud UI page.

### actual-budget-headers
Special headers for SharedArrayBuffer (`COEP: require-corp`).

## Path-Based Routing

Same-origin iframe embedding:
1. Parent: `http://localhost:8080/apps/miniflux`
2. Iframe: `http://localhost:8080/embed/miniflux/`
3. Same origin = cookies work, no CORS issues

### stripPrefix Behavior

Default: strip `/embed/<app>` prefix.

Exception: Apps with `routing.stripPrefix: false` (e.g., miniflux with BASE_URL).

## Generated Routes (traefikgen)

`host-agent/internal/traefikgen/` generates `apps-routes.yml`:
```yaml
http:
  routers:
    miniflux-backend:
      rule: "PathPrefix(`/embed/miniflux`)"
      middlewares:
        - iframe-headers
        - embed-isolation
      service: miniflux
      priority: 100
```

## Debugging

```bash
# View config
podman exec traefik cat /etc/traefik/dynamic/apps-routes.yml

# Logs
journalctl --user -u podman-traefik -f

# Test headers
curl -sI http://localhost:8080/embed/miniflux/ | grep -i cross-origin
```

## Dashboard
`http://localhost:8080/dashboard/`
