name: authentik
displayName: Authentik
description: Open-source identity provider for SSO, user management, and authentication
category: security
port: 9001
isSystem: true

integrations:
  database:
    required: true
    multi: false
    compatible:
      - app: postgres
        default: true
  cache:
    required: true
    multi: false
    compatible:
      - app: redis
        default: true

healthCheck:
  path: /-/health/live/
  interval: 2
  timeout: 90

# Traefik routes for Authentik - uses subdomain to avoid SW rewriting issues
# All Authentik traffic goes to auth.localhost which is cross-origin from localhost,
# so the service worker naturally passes it through without interference.
traefikConfig:
  http:
    routers:
      # Main Authentik router - catches all traffic to auth.localhost
      authentik:
        rule: "Host(`auth.localhost`)"
        middlewares:
          - authentik-iframe-headers
        service: authentik
        priority: 100

    middlewares:
      # Allow Authentik to be embedded in iframes from same origin
      authentik-iframe-headers:
        headers:
          customResponseHeaders:
            # Clear X-Frame-Options (CSP takes precedence in modern browsers)
            X-Frame-Options: ""
            # Allow framing from same origin (both localhost and auth.localhost)
            Content-Security-Policy: "frame-ancestors 'self' http://localhost:* https://localhost:* http://auth.localhost:* https://auth.localhost:*"
            # COEP required when parent has COEP (Actual Budget uses it for SharedArrayBuffer)
            Cross-Origin-Embedder-Policy: "credentialless"
            Cross-Origin-Resource-Policy: "cross-origin"

    services:
      authentik:
        loadBalancer:
          servers:
            - url: "http://localhost:9001"
