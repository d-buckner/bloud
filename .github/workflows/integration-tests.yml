name: Integration Tests

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  integration-tests:
    runs-on: self-hosted
    timeout-minutes: 60

    steps:
      - name: Mask sensitive paths
        run: |
          echo "::add-mask::$HOME"
          echo "::add-mask::$(pwd)"

      - name: Set architecture
        id: set-arch
        run: |
          if [ "${{ runner.arch }}" = "ARM64" ]; then
            echo "ARCH=aarch64" >> $GITHUB_ENV
          else
            echo "ARCH=x86_64" >> $GITHUB_ENV
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Lima
        run: |
          LIMA_VERSION="v2.0.3"
          LIMA_URL="https://github.com/lima-vm/lima/releases/download/${LIMA_VERSION}/lima-${LIMA_VERSION#v}-Linux-${ARCH}.tar.gz"
          mkdir -p "$GITHUB_WORKSPACE/.lima-install"
          curl -fsSL "$LIMA_URL" | tar xzf - -C "$GITHUB_WORKSPACE/.lima-install"
          echo "$GITHUB_WORKSPACE/.lima-install/bin" >> $GITHUB_PATH
          echo "LIMA_HOME=$GITHUB_WORKSPACE/.lima" >> $GITHUB_ENV

      - name: Verify Lima
        run: limactl --version

      - name: Check virtualization support
        run: |
          echo "Checking KVM..."
          ls -la /dev/kvm || echo "/dev/kvm not found"
          echo "Checking QEMU..."
          which qemu-system-x86_64 || which qemu-system-aarch64 || echo "QEMU not in PATH"
          echo "Checking user groups..."
          id
          groups
          echo "Testing KVM access..."
          if [ -r /dev/kvm ] && [ -w /dev/kvm ]; then
            echo "KVM is readable and writable"
          else
            echo "WARNING: KVM access may be restricted"
            ls -la /dev/kvm
          fi

      - name: Install sshpass
        run: |
          if ! command -v sshpass &> /dev/null; then
            echo "Extracting sshpass from Debian package..."
            mkdir -p "$GITHUB_WORKSPACE/.bin" "$GITHUB_WORKSPACE/.tmp"
            cd "$GITHUB_WORKSPACE/.tmp"
            curl -fsSL http://deb.debian.org/debian/pool/main/s/sshpass/sshpass_1.10-0.1_amd64.deb -o sshpass.deb
            ar x sshpass.deb
            tar --no-same-owner --no-same-permissions -xf data.tar.xz
            cp usr/bin/sshpass "$GITHUB_WORKSPACE/.bin/"
            cd "$GITHUB_WORKSPACE"
            rm -rf "$GITHUB_WORKSPACE/.tmp"
            echo "$GITHUB_WORKSPACE/.bin" >> $GITHUB_PATH
          fi

      - name: Verify sshpass
        run: sshpass -V

      - name: Build CLI
        run: |
          cd cli && go build -o ../bloud .

      - name: Cache VM image
        id: cache-vm-image
        uses: actions/cache@v4
        with:
          path: lima/imgs/nixos-24.11-lima.img
          key: vm-image-nixos-24.11-${{ env.ARCH }}

      - name: Download VM image
        if: steps.cache-vm-image.outputs.cache-hit != 'true'
        run: |
          mkdir -p lima/imgs

          IMAGE_URL="https://github.com/d-buckner/bloud/releases/latest/download/nixos-24.11-${ARCH}.img.gz"
          echo "Downloading VM image from: $IMAGE_URL"

          curl -fsSL "$IMAGE_URL" | gunzip > lima/imgs/nixos-24.11-lima.img

          echo "VM image downloaded and extracted"
          ls -lh lima/imgs/

      - name: Install integration test dependencies
        working-directory: integration
        run: |
          npm ci
          npx playwright install chromium

      - name: Start test VM
        run: |
          # Clean up any existing test VM
          ./bloud test stop 2>/dev/null || true

          # Show generated Lima config for debugging
          echo "=== Generated Lima config ==="
          cat lima/test-nixos.yaml 2>/dev/null || echo "Config not generated yet"

          # Start fresh test VM with verbose output
          ./bloud test start &
          BLOUD_PID=$!

          # Monitor VM startup in background
          sleep 10
          echo "=== Lima VM status ==="
          limactl list --json || true
          echo "=== QEMU processes ==="
          ps aux | grep -E "(qemu|lima)" | grep -v grep || true

          # Wait for bloud to complete
          wait $BLOUD_PID
        timeout-minutes: 20

      - name: Wait for services
        run: |
          echo "Waiting for services to be ready..."

          wait_for_service() {
            local name="$1"
            local url="$2"
            local max_attempts=30
            local attempt=1

            while [ $attempt -le $max_attempts ]; do
              if curl -sf -o /dev/null "$url" 2>/dev/null; then
                echo "$name is ready"
                return 0
              fi
              echo "Waiting for $name... ($attempt/$max_attempts)"
              sleep 2
              attempt=$((attempt + 1))
            done

            echo "Error: $name failed to start"
            return 1
          }

          wait_for_service "Go API" "http://localhost:3001/api/health"
          wait_for_service "Vite" "http://localhost:5174"
          wait_for_service "Traefik" "http://localhost:8081"

          echo "All services ready!"

      - name: Run integration tests
        working-directory: integration
        run: |
          SKIP_VM_LIFECYCLE=true npx playwright test
        env:
          BASE_URL: http://localhost:8081
          API_URL: http://localhost:3001
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: integration/playwright-report/
          retention-days: 30

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: integration/test-results/
          retention-days: 7

      - name: Debug VM state on failure
        if: failure()
        run: |
          echo "=== Lima VM status ==="
          limactl list --json 2>&1 || true
          echo "=== Lima VM info ==="
          limactl info bloud-test 2>&1 || true
          echo "=== QEMU processes ==="
          ps aux | grep -E "(qemu|lima)" | grep -v grep || true
          echo "=== Lima logs ==="
          cat "$LIMA_HOME/bloud-test/ha.stderr.log" 2>/dev/null | tail -100 || true
          cat "$LIMA_HOME/bloud-test/serial.log" 2>/dev/null | tail -100 || true
          echo "=== Generated Lima config ==="
          cat lima/test-nixos.yaml 2>/dev/null || true

      - name: Cleanup test VM
        if: always()
        run: |
          ./bloud test stop 2>/dev/null || true
