#!/bin/bash
# Unified Lima VM development script
#
# Usage:
#   ./lima/dev vm-start - Start the Lima VM
#   ./lima/dev vm-stop  - Stop the Lima VM
#   ./lima/dev start    - Start dev environment (hot reload)
#   ./lima/dev stop     - Stop dev services
#   ./lima/dev attach   - Attach to tmux session
#   ./lima/dev logs     - Tail service logs
#   ./lima/dev status   - Show service status
#   ./lima/dev shell    - Interactive shell in VM
#   ./lima/dev rebuild  - Rebuild NixOS config
#   ./lima/dev install <app>  - Install an app via API
#   ./lima/dev ports    - Start SSH port forwarding (run in separate terminal)

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
VM_NAME="bloud"
VM_USER="bloud"
VM_PASSWORD="bloud"
PROJECT_IN_VM="/home/bloud.linux/bloud"
TMUX_SESSION="bloud-dev"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log() { echo -e "${GREEN}==>${NC} $1"; }
warn() { echo -e "${YELLOW}Warning:${NC} $1"; }
error() { echo -e "${RED}Error:${NC} $1"; exit 1; }

# Check if VM is running
check_vm() {
    if ! limactl list 2>/dev/null | grep -q "$VM_NAME.*Running"; then
        error "VM '$VM_NAME' is not running. Start it with: ./lima/dev vm-start"
    fi
}

# Wait for SSH to be ready using sshpass
wait_for_ssh() {
    local max_attempts=60
    local attempt=1

    while [ $attempt -le $max_attempts ]; do
        local ssh_port
        ssh_port=$(get_ssh_port 2>/dev/null)

        if [ -n "$ssh_port" ] && [ "$ssh_port" != "null" ] && [ "$ssh_port" != "0" ]; then
            if sshpass -p "$VM_PASSWORD" ssh \
                -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o PreferredAuthentications=password \
                -o PubkeyAuthentication=no \
                -o LogLevel=ERROR \
                -o ConnectTimeout=2 \
                -p "$ssh_port" \
                "$VM_USER@127.0.0.1" \
                "true" 2>/dev/null; then
                return 0
            fi
        fi

        echo -ne "\r  Waiting for SSH... ($attempt/$max_attempts)"
        sleep 2
        attempt=$((attempt + 1))
    done

    echo ""
    return 1
}

# Start the Lima VM
cmd_vm_start() {
    if limactl list 2>/dev/null | grep -q "$VM_NAME.*Running"; then
        log "VM '$VM_NAME' is already running"
        return 0
    fi

    if limactl list 2>/dev/null | grep -q "$VM_NAME.*Stopped"; then
        log "Starting existing VM '$VM_NAME'..."
        # Start in background - Lima's SSH check won't work, but we'll use sshpass
        limactl start "$VM_NAME" --tty=false &
        local lima_pid=$!
    else
        log "Creating and starting VM '$VM_NAME'..."
        limactl start --name="$VM_NAME" "$SCRIPT_DIR/nixos.yaml" --tty=false &
        local lima_pid=$!
    fi

    # Wait for our password-based SSH to work
    log "Waiting for VM to boot..."
    sleep 5  # Give QEMU time to start

    if wait_for_ssh; then
        echo ""
        log "VM started successfully"

        # Kill the limactl process if still waiting (it's stuck on key-based SSH)
        kill $lima_pid 2>/dev/null || true

        # Mount 9p filesystems (Lima's boot script didn't run because we use password auth)
        # Using access=any so VM user can read/write Mac-owned files
        # Using cache=none to avoid stale metadata (important for hot reload)
        log "Mounting shared directories..."
        vm_exec "sudo mount -t 9p -o trans=virtio,version=9p2000.L,msize=131072,cache=none,access=any mount0 /home/bloud.linux/bloud 2>/dev/null || true"
        vm_exec "sudo mount -t 9p -o trans=virtio,version=9p2000.L,msize=131072,cache=none,access=any mount1 /tmp/lima 2>/dev/null || true"

        echo ""
        echo "Next steps:"
        echo "  ./lima/dev start    # Start hot reload dev environment"
        echo "  ./lima/dev ports    # (optional) Forward ports in another terminal"
    else
        echo ""
        error "VM failed to start (SSH not available after 2 minutes)"
    fi
}

# Stop the Lima VM
cmd_vm_stop() {
    if ! limactl list 2>/dev/null | grep -q "$VM_NAME"; then
        log "VM '$VM_NAME' does not exist"
        return 0
    fi

    if limactl list 2>/dev/null | grep -q "$VM_NAME.*Stopped"; then
        log "VM '$VM_NAME' is already stopped"
        return 0
    fi

    log "Stopping VM '$VM_NAME'..."

    # Kill port forwarding first
    pkill -f "ssh.*-L 3000:localhost:3000.*bloud@" 2>/dev/null || true

    limactl stop "$VM_NAME"
    log "VM stopped"
}

# Get SSH port
get_ssh_port() {
    limactl list --format json 2>/dev/null | jq -r "select(.name==\"$VM_NAME\") | .sshLocalPort" | head -1
}

# Run command in VM
vm_exec() {
    local ssh_port
    ssh_port=$(get_ssh_port)

    if [ -z "$ssh_port" ] || [ "$ssh_port" = "null" ]; then
        error "Could not determine SSH port for VM"
    fi

    sshpass -p "$VM_PASSWORD" ssh \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o PreferredAuthentications=password \
        -o PubkeyAuthentication=no \
        -o LogLevel=ERROR \
        -p "$ssh_port" \
        "$VM_USER@127.0.0.1" \
        "$@"
}

# Interactive SSH to VM
vm_ssh() {
    local ssh_port
    ssh_port=$(get_ssh_port)

    if [ -z "$ssh_port" ] || [ "$ssh_port" = "null" ]; then
        error "Could not determine SSH port for VM"
    fi

    sshpass -p "$VM_PASSWORD" ssh \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o PreferredAuthentications=password \
        -o PubkeyAuthentication=no \
        -o LogLevel=ERROR \
        -t \
        -p "$ssh_port" \
        "$VM_USER@127.0.0.1" \
        "$@"
}

cmd_start() {
    check_vm

    # Start port forwarding in background if not already running
    if ! pgrep -f "ssh.*-L 3000:localhost:3000.*bloud@" >/dev/null 2>&1; then
        log "Starting port forwarding..."
        start_port_forwarding &
        sleep 2
    else
        log "Port forwarding already running"
    fi

    log "Starting hot reload dev environment..."
    vm_exec "bash $PROJECT_IN_VM/lima/start-dev.sh"
}

start_port_forwarding() {
    local ssh_port
    ssh_port=$(get_ssh_port)

    # Run SSH port forwarding in background
    sshpass -p "$VM_PASSWORD" ssh \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o PreferredAuthentications=password \
        -o PubkeyAuthentication=no \
        -o LogLevel=ERROR \
        -o ServerAliveInterval=60 \
        -o ExitOnForwardFailure=yes \
        -N \
        -L 3000:localhost:3000 \
        -L 5173:localhost:5173 \
        -L 8080:localhost:8080 \
        -L 8085:localhost:8085 \
        -L 9001:localhost:9001 \
        -L 5006:localhost:5006 \
        -L 3080:localhost:3080 \
        -p "$ssh_port" \
        "$VM_USER@127.0.0.1" &
}

cmd_stop() {
    check_vm
    log "Stopping dev services..."

    # Kill tmux session in VM
    vm_exec "tmux kill-session -t $TMUX_SESSION 2>/dev/null || true"

    # Also kill any stray processes
    vm_exec 'pkill -f "air" 2>/dev/null || true; pkill -f "vite" 2>/dev/null || true'

    # Kill port forwarding
    pkill -f "ssh.*-L 3000:localhost:3000.*bloud@" 2>/dev/null || true
    log "Services stopped"
}

cmd_attach() {
    check_vm

    # Check if tmux session exists
    if ! vm_exec "tmux has-session -t $TMUX_SESSION 2>/dev/null"; then
        error "Dev environment not running. Start with: ./lima/dev start"
    fi

    log "Attaching to dev session (Ctrl-B D to detach)..."
    vm_ssh "tmux attach -t $TMUX_SESSION"
}

cmd_logs() {
    check_vm

    # Check if tmux session exists
    if ! vm_exec "tmux has-session -t $TMUX_SESSION 2>/dev/null"; then
        error "Dev environment not running. Start with: ./lima/dev start"
    fi

    log "Capturing output from tmux (Ctrl+C to stop)..."
    echo ""
    echo -e "${CYAN}=== Go (air) ===${NC}"
    vm_exec "tmux capture-pane -t $TMUX_SESSION:dev.0 -p -S -50" 2>/dev/null || true
    echo ""
    echo -e "${CYAN}=== Web (vite) ===${NC}"
    vm_exec "tmux capture-pane -t $TMUX_SESSION:dev.1 -p -S -50" 2>/dev/null || true
}

cmd_status() {
    check_vm
    echo ""
    log "Checking service status..."
    echo ""

    # Check if tmux session is running
    if vm_exec "tmux has-session -t $TMUX_SESSION 2>/dev/null"; then
        echo -e "  Tmux Session: ${GREEN}Running${NC}"
    else
        echo -e "  Tmux Session: ${RED}Not running${NC}"
        echo ""
        echo "  Run './lima/dev start' to start the dev environment"
        return
    fi

    # Check host-agent
    if vm_exec 'curl -s http://localhost:3000/api/health 2>/dev/null' | grep -q "ok"; then
        echo -e "  Host Agent:   ${GREEN}Running${NC} (http://localhost:3000)"
    else
        echo -e "  Host Agent:   ${YELLOW}Starting...${NC}"
    fi

    # Check web (via Traefik)
    if vm_exec 'curl -s http://localhost:8080 2>/dev/null' | grep -q "html"; then
        echo -e "  Web UI:       ${GREEN}Running${NC} (http://localhost:8080)"
    else
        echo -e "  Web UI:       ${YELLOW}Starting...${NC}"
    fi

    # Check port forwarding
    if pgrep -f "ssh.*-L 3000:localhost:3000.*bloud@" >/dev/null 2>&1; then
        echo -e "  Port Forward: ${GREEN}Active${NC}"
    else
        echo -e "  Port Forward: ${RED}Not running${NC}"
    fi

    # Check podman containers
    echo ""
    log "Podman containers:"
    vm_exec 'podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"' 2>/dev/null || echo "  (none running)"
    echo ""
}

cmd_shell() {
    check_vm
    if [ $# -gt 0 ]; then
        # Run command if provided
        vm_exec "$@"
    else
        # Interactive shell
        vm_ssh bash
    fi
}

cmd_rebuild() {
    check_vm
    log "Rebuilding NixOS configuration..."
    vm_exec "sudo nixos-rebuild switch --flake $PROJECT_IN_VM#vm-dev --impure"
}

cmd_restart() {
    check_vm
    log "Restarting dev environment..."
    cmd_stop
    sleep 1
    cmd_start
}

cmd_install() {
    local app="$1"
    if [ -z "$app" ]; then
        error "Usage: ./lima/dev install <app-name>"
    fi
    check_vm
    log "Installing $app..."
    vm_exec "curl -X POST http://localhost:3000/api/apps/$app/install"
    echo ""
}

cmd_ports() {
    check_vm
    local ssh_port
    ssh_port=$(get_ssh_port)

    log "Starting SSH port forwarding..."
    echo ""
    echo "Forwarding ports:"
    echo "  3000 -> Host Agent API"
    echo "  5173 -> Web Dev Server (Vite HMR)"
    echo "  8080 -> Traefik (path-based routing)"
    echo "  8085 -> Miniflux (direct)"
    echo "  9001 -> Authentik"
    echo "  5006 -> Actual Budget (direct)"
    echo ""
    echo "Press Ctrl+C to stop port forwarding"
    echo ""

    # SSH port forwarding for all dev ports
    exec sshpass -p "$VM_PASSWORD" ssh \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o PreferredAuthentications=password \
        -o PubkeyAuthentication=no \
        -o LogLevel=ERROR \
        -N \
        -L 3000:localhost:3000 \
        -L 5173:localhost:5173 \
        -L 8080:localhost:8080 \
        -L 8085:localhost:8085 \
        -L 9001:localhost:9001 \
        -L 5006:localhost:5006 \
        -L 3080:localhost:3080 \
        -p "$ssh_port" \
        "$VM_USER@127.0.0.1"
}

cmd_help() {
    echo "Bloud Lima VM Development Tool"
    echo ""
    echo "Usage: ./lima/dev <command> [args]"
    echo ""
    echo "VM Commands:"
    echo "  vm-start        Start the Lima VM"
    echo "  vm-stop         Stop the Lima VM"
    echo ""
    echo "Dev Commands:"
    echo "  start           Start hot reload dev environment (air + vite)"
    echo "  stop            Stop dev services"
    echo "  restart         Restart dev services"
    echo "  attach          Attach to tmux session (Ctrl-B D to detach)"
    echo "  logs            Show recent output from servers"
    echo "  status          Show service status"
    echo ""
    echo "Other Commands:"
    echo "  shell [cmd]     Interactive shell in VM (or run a command)"
    echo "  rebuild         Rebuild NixOS config"
    echo "  install <app>   Install an app via API"
    echo "  ports           Start SSH port forwarding (run in separate terminal)"
    echo ""
    echo "Workflow:"
    echo "  1. ./lima/dev vm-start    # Start the VM (first time or after reboot)"
    echo "  2. ./lima/dev start       # Start hot reload servers"
    echo "  3. Edit files in your editor - changes auto-reload!"
    echo "  4. ./lima/dev attach      # View server output"
    echo ""
    echo "URLs (after start):"
    echo "  http://localhost:8080     # Web UI (via Traefik)"
    echo "  http://localhost:3000     # Go API (air with hot reload)"
}

# Check for sshpass
if ! command -v sshpass &>/dev/null; then
    echo "Installing sshpass..."
    brew install hudochenkov/sshpass/sshpass
fi

# Main
case "${1:-help}" in
    vm-start)  cmd_vm_start ;;
    vm-stop)   cmd_vm_stop ;;
    start)     cmd_start ;;
    stop)      cmd_stop ;;
    restart)   cmd_restart ;;
    attach)    cmd_attach ;;
    logs)      cmd_logs ;;
    status)    cmd_status ;;
    shell)     shift; cmd_shell "$@" ;;
    rebuild)   cmd_rebuild ;;
    install)   cmd_install "$2" ;;
    ports)     cmd_ports ;;
    help|--help|-h) cmd_help ;;
    *)         error "Unknown command: $1. Run './lima/dev help' for usage." ;;
esac
